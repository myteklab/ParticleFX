<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particle FX Designer</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Embedded mode - hide standalone UI elements */
        body.embedded-mode #btn-save,
        body.embedded-mode #btn-export,
        body.embedded-mode #btn-export-asset,
        body.embedded-mode #btn-screenshot,
        body.embedded-mode #btn-share {
            display: none !important;
        }

        .embedded-banner {
            display: none;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: white;
            text-align: center;
            padding: 10px 20px;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        body.embedded-mode .embedded-banner {
            display: block;
        }
    </style>
</head>
<body>
    <div class="embedded-banner" id="embeddedBanner">
        Editing particle effect for GameMaker â€” click <strong>"Save & Use Effect"</strong> above when done
    </div>

    <!-- Toast notifications -->
    <div id="toast-container"></div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content help-modal-content">
            <div class="modal-header">
                <h2 id="help-modal-title">Help</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body" id="help-modal-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Asset URL Modal -->
    <div id="asset-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Asset URL</h2>
                <button class="modal-close" onclick="closeAssetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-instructions">Use this URL to load your particle effect in GameMaker and other applications:</p>

                <div class="code-section">
                    <div class="code-header">
                        <span>Effect URL</span>
                        <button class="copy-btn" onclick="copyCode('asset-url')">Copy URL</button>
                    </div>
                    <pre id="asset-url" class="code-block"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Your Effect</h2>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-instructions">Share your particle effect with others! Anyone with this link can view and interact with your effect.</p>

                <div class="code-section">
                    <div class="code-header">
                        <span>Share Link</span>
                        <button class="copy-btn" id="copy-share-btn" onclick="copyShareLink()">Copy Link</button>
                    </div>
                    <pre id="share-url" class="code-block"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Randomize Modal -->
    <div id="randomize-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>&#127922; Randomize Effect</h2>
                <button class="modal-close" onclick="closeRandomizeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-instructions">Generate random particle effects! Choose how you want to randomize:</p>

                <div class="randomize-options">
                    <div class="randomize-option">
                        <input type="radio" name="randomize-mode" id="randomize-current" value="current" checked>
                        <label for="randomize-current">
                            <strong>Current Layer Only</strong>
                            <span class="option-desc">Randomize just the selected layer</span>
                        </label>
                    </div>
                    <div class="randomize-option">
                        <input type="radio" name="randomize-mode" id="randomize-all" value="all">
                        <label for="randomize-all">
                            <strong>All Existing Layers</strong>
                            <span class="option-desc">Randomize all layers with different effects</span>
                        </label>
                    </div>
                    <div class="randomize-option">
                        <input type="radio" name="randomize-mode" id="randomize-new" value="new">
                        <label for="randomize-new">
                            <strong>Create New Random Layers</strong>
                            <span class="option-desc">Clear and create fresh random layers</span>
                        </label>
                    </div>
                </div>

                <div class="randomize-layers-count" id="layers-count-section" style="display: none;">
                    <label for="random-layer-count">Number of layers:</label>
                    <div class="layer-count-control">
                        <button class="layer-count-btn" onclick="adjustLayerCount(-1)">-</button>
                        <input type="number" id="random-layer-count" value="3" min="1" max="8">
                        <button class="layer-count-btn" onclick="adjustLayerCount(1)">+</button>
                    </div>
                </div>

                <div class="randomize-link-option" id="link-option-section" style="display: none;">
                    <label class="link-option-toggle">
                        <input type="checkbox" id="randomize-link-positions" checked>
                        <span>&#128279; Link positions (move all layers together)</span>
                    </label>
                </div>

                <div class="randomize-warning" id="randomize-warning">
                    <span class="warning-icon">&#9888;</span>
                    <span class="warning-text">This will replace your current work with randomly generated layers.</span>
                </div>

                <div class="randomize-actions">
                    <button class="action-btn secondary" onclick="closeRandomizeModal()">Cancel</button>
                    <button class="action-btn primary large" onclick="executeRandomize()">
                        <span class="icon">&#127922;</span> Randomize!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main container -->
    <div class="app-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="toolbar-brand">
                    <h1>Particle FX Designer</h1>
                    <button class="help-icon-btn" onclick="showHelp('about')" title="About ParticleFX">?</button>
                </div>
                <div class="toolbar-divider"></div>

                <!-- File Menu -->
                <div class="menu-dropdown">
                    <button class="menu-btn" onclick="toggleMenu('file-menu')">File &#9662;</button>
                    <div class="menu-content" id="file-menu">
                        <button class="menu-item" id="btn-save">
                            <span class="menu-icon">&#128190;</span>
                            <span class="menu-label">Save</span>
                            <span class="menu-shortcut">Ctrl+S</span>
                        </button>
                        <div class="menu-divider"></div>
                        <button class="menu-item" id="btn-export">
                            <span class="menu-icon">&#128228;</span>
                            <span class="menu-label">Download JSON</span>
                        </button>
                        <button class="menu-item" id="btn-export-asset">
                            <span class="menu-icon">&#128230;</span>
                            <span class="menu-label">Export to Assets</span>
                        </button>
                        <button class="menu-item" id="btn-screenshot">
                            <span class="menu-icon">&#128247;</span>
                            <span class="menu-label">Save Screenshot</span>
                        </button>
                    </div>
                </div>

                <!-- Edit Menu -->
                <div class="menu-dropdown">
                    <button class="menu-btn" onclick="toggleMenu('edit-menu')">Edit &#9662;</button>
                    <div class="menu-content" id="edit-menu">
                        <button class="menu-item" id="btn-undo">
                            <span class="menu-icon">&#8617;</span>
                            <span class="menu-label">Undo</span>
                            <span class="menu-shortcut">Ctrl+Z</span>
                        </button>
                        <button class="menu-item" id="btn-redo">
                            <span class="menu-icon">&#8618;</span>
                            <span class="menu-label">Redo</span>
                            <span class="menu-shortcut">Ctrl+Y</span>
                        </button>
                    </div>
                </div>

                <div class="toolbar-divider"></div>

                <!-- Action buttons -->
                <button id="btn-play" class="toolbar-btn active" title="Play/Pause (Space)">
                    <span class="icon">&#9658;</span> Play
                </button>
                <button id="btn-reset" class="toolbar-btn" title="Clear Particles (R)">
                    <span class="icon">&#8635;</span> Reset
                </button>
                <div class="toolbar-divider"></div>
                <button id="btn-randomize" class="toolbar-btn" title="Randomize Effect">
                    <span class="icon">&#127922;</span> Randomize
                </button>
                <div class="toolbar-divider"></div>
                <button id="btn-share" class="toolbar-btn" title="Share Effect">
                    <span class="icon">&#128279;</span> Share
                </button>
            </div>
            <div class="toolbar-right">
                <span id="particle-count">0 particles</span>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Canvas area -->
            <div class="canvas-container">
                <canvas id="particle-canvas" width="800" height="600"></canvas>
                <div class="canvas-hint">Click to move emitter</div>
            </div>

            <!-- Control panel -->
            <div class="control-panel">
                <div class="panel-resize-handle" id="panel-resize-handle"></div>

                <!-- Layers section -->
                <div class="panel-section layers-section" data-section="layers">
                    <div class="section-header-with-actions" onclick="toggleSection('layers', event)">
                        <h3><span class="section-collapse-icon">&#9660;</span> Layers <button class="help-icon" onclick="showHelp('layers'); event.stopPropagation();" title="Learn about layers">?</button></h3>
                        <span id="layer-count" class="layer-count-badge">1 layer</span>
                    </div>
                    <div class="section-content">
                    <div class="layer-toolbar">
                        <button id="btn-add-layer" class="layer-btn" title="Add Layer">+</button>
                        <button id="btn-duplicate-layer" class="layer-btn" title="Duplicate Layer (Ctrl+D)">&#128203;</button>
                        <button id="btn-delete-layer" class="layer-btn" title="Delete Layer (Del)">&#128465;</button>
                        <div class="layer-toolbar-divider"></div>
                        <button id="btn-layer-up" class="layer-btn" title="Move Up (renders later/on top)">&#9650;</button>
                        <button id="btn-layer-down" class="layer-btn" title="Move Down (renders earlier/behind)">&#9660;</button>
                    </div>
                    <div class="link-positions-row">
                        <label class="link-positions-toggle" title="When enabled, clicking the canvas moves all layers together">
                            <input type="checkbox" id="link-positions">
                            <span class="link-icon">&#128279;</span>
                            <span class="link-label">Link Positions</span>
                        </label>
                        <button id="btn-center-all" class="center-all-btn" title="Center all layers on canvas">&#8857; Center All</button>
                    </div>
                    <div id="layer-list" class="layer-list">
                        <!-- Layer items rendered by JavaScript -->
                    </div>
                    </div>
                </div>

                <!-- Presets section -->
                <div class="panel-section" data-section="presets">
                    <div class="section-header" onclick="toggleSection('presets', event)">
                        <h3><span class="section-collapse-icon">&#9660;</span> Presets <button class="help-icon" onclick="showHelp('presets'); event.stopPropagation();" title="Learn about presets">?</button></h3>
                    </div>
                    <div class="section-content">
                    <div class="preset-grid">
                        <button class="preset-btn" data-preset="fire" title="Fire">&#128293;</button>
                        <button class="preset-btn" data-preset="smoke" title="Smoke">&#128168;</button>
                        <button class="preset-btn" data-preset="sparkles" title="Sparkles">&#10024;</button>
                        <button class="preset-btn" data-preset="snow" title="Snow">&#10052;</button>
                        <button class="preset-btn" data-preset="rain" title="Rain">&#127783;</button>
                        <button class="preset-btn" data-preset="explosion" title="Explosion">&#128165;</button>
                        <button class="preset-btn" data-preset="fireworks" title="Fireworks">&#127878;</button>
                        <button class="preset-btn" data-preset="bubbles" title="Bubbles">&#129767;</button>
                        <button class="preset-btn" data-preset="leaves" title="Leaves">&#127810;</button>
                        <button class="preset-btn" data-preset="magic" title="Magic">&#129668;</button>
                    </div>
                    </div>
                </div>

                <!-- Emitter settings -->
                <div class="panel-section" data-section="emitter">
                    <div class="section-header" onclick="toggleSection('emitter', event)">
                        <h3><span class="section-collapse-icon">&#9660;</span> Emitter Settings <button class="help-icon" onclick="showHelp('emitter'); event.stopPropagation();" title="Learn about emitter settings">?</button></h3>
                    </div>
                    <div class="section-content">
                    <div class="control-row">
                        <label>Emitter Shape <button class="help-icon-small" onclick="showHelp('emitterShape')" title="Learn about emitter shapes">?</button></label>
                        <div class="emitter-shape-buttons">
                            <button class="emitter-shape-btn active" data-emitter-shape="point" title="Point">&#9679;</button>
                            <button class="emitter-shape-btn" data-emitter-shape="line" title="Line">&#9135;</button>
                            <button class="emitter-shape-btn" data-emitter-shape="circle" title="Circle">&#9711;</button>
                            <button class="emitter-shape-btn" data-emitter-shape="rectangle" title="Rectangle">&#9634;</button>
                        </div>
                    </div>

                    <!-- Emitter shape parameters (shown/hidden based on shape) -->
                    <div id="emitter-shape-params">
                        <div class="control-row emitter-param" id="emitter-width-row" style="display: none;">
                            <label>Width</label>
                            <input type="range" id="emitterWidth" min="10" max="800" value="100">
                            <span class="value-display" id="emitterWidth-value">100</span>
                        </div>
                        <div class="control-row emitter-param" id="emitter-height-row" style="display: none;">
                            <label>Height</label>
                            <input type="range" id="emitterHeight" min="10" max="600" value="50">
                            <span class="value-display" id="emitterHeight-value">50</span>
                        </div>
                        <div class="control-row emitter-param" id="emitter-radius-row" style="display: none;">
                            <label>Radius</label>
                            <input type="range" id="emitterRadius" min="10" max="400" value="50">
                            <span class="value-display" id="emitterRadius-value">50</span>
                        </div>
                        <div class="control-row emitter-param" id="emitter-filled-row" style="display: none;">
                            <label>Spawn Inside</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="emitterFilled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="blend-hint">Uncheck to spawn on edge only</span>
                        </div>
                    </div>

                    <div class="control-row">
                        <label>Rate <button class="help-icon-small" onclick="showHelp('rate')" title="Learn about rate">?</button></label>
                        <input type="range" id="rate" min="1" max="200" value="50">
                        <span class="value-display" id="rate-value">50/s</span>
                    </div>

                    <div class="control-row">
                        <label>Lifetime <button class="help-icon-small" onclick="showHelp('lifetime')" title="Learn about lifetime">?</button></label>
                        <input type="range" id="lifetime" min="0.1" max="5" step="0.1" value="2">
                        <span class="value-display" id="lifetime-value">2.0s</span>
                    </div>

                    <div class="control-row">
                        <label>Speed <button class="help-icon-small" onclick="showHelp('speed')" title="Learn about speed">?</button></label>
                        <input type="range" id="speed" min="0" max="300" value="100">
                        <span class="value-display" id="speed-value">100</span>
                    </div>

                    <div class="control-row">
                        <label>Spread <button class="help-icon-small" onclick="showHelp('spread')" title="Learn about spread">?</button></label>
                        <input type="range" id="spread" min="0" max="360" value="45">
                        <span class="value-display" id="spread-value">45&deg;</span>
                    </div>

                    <div class="control-row">
                        <label>Gravity <button class="help-icon-small" onclick="showHelp('gravity')" title="Learn about gravity">?</button></label>
                        <input type="range" id="gravity" min="-200" max="200" value="0">
                        <span class="value-display" id="gravity-value">0</span>
                    </div>

                    <div class="control-row">
                        <label>Friction <button class="help-icon-small" onclick="showHelp('friction')" title="Learn about friction">?</button></label>
                        <input type="range" id="friction" min="0.9" max="1" step="0.005" value="1">
                        <span class="value-display" id="friction-value">1.00</span>
                    </div>

                    <div class="control-row">
                        <label>Direction <button class="help-icon-small" onclick="showHelp('direction')" title="Learn about direction">?</button></label>
                        <input type="range" id="angle" min="-180" max="180" value="-90">
                        <span class="value-display" id="angle-value">-90&deg;</span>
                    </div>
                    </div>
                </div>

                <!-- Particle appearance -->
                <div class="panel-section" data-section="particle">
                    <div class="section-header" onclick="toggleSection('particle', event)">
                        <h3><span class="section-collapse-icon">&#9660;</span> Particle Appearance <button class="help-icon" onclick="showHelp('particle'); event.stopPropagation();" title="Learn about particle appearance">?</button></h3>
                    </div>
                    <div class="section-content">
                    <div class="control-row">
                        <label>Shape <button class="help-icon-small" onclick="showHelp('shape')" title="Learn about shapes">?</button></label>
                        <div class="shape-buttons">
                            <button class="shape-btn active" data-shape="circle" title="Circle">&#9679;</button>
                            <button class="shape-btn" data-shape="square" title="Square">&#9632;</button>
                            <button class="shape-btn" data-shape="star" title="Star">&#9733;</button>
                            <button class="shape-btn" data-shape="spark" title="Spark">&#10022;</button>
                            <button class="shape-btn" data-shape="snowflake" title="Snowflake">&#10052;</button>
                            <button class="shape-btn" data-shape="emoji" title="Emoji" id="emoji-shape-btn">&#128512;</button>
                        </div>
                    </div>

                    <!-- Emoji Picker (shown when emoji shape is selected) -->
                    <div class="control-row emoji-picker-row" id="emoji-picker-row" style="display: none;">
                        <label>Select Emoji</label>
                        <div class="performance-note">
                            <span class="note-icon">&#128161;</span>
                            <span class="note-text"><strong>Performance tip:</strong> Emojis render slower than basic shapes because text/glyph rendering is more complex. For smoother effects, try lowering the <em>Rate</em> or using basic shapes like circles.</span>
                        </div>
                        <div class="emoji-picker">
                            <div class="emoji-grid" id="emoji-grid">
                                <!-- Popular emojis organized by category -->
                                <button class="emoji-btn" data-emoji="&#10084;&#65039;" title="Heart">&#10084;&#65039;</button>
                                <button class="emoji-btn" data-emoji="&#11088;" title="Star">&#11088;</button>
                                <button class="emoji-btn" data-emoji="&#10024;" title="Sparkles">&#10024;</button>
                                <button class="emoji-btn" data-emoji="&#128171;" title="Dizzy">&#128171;</button>
                                <button class="emoji-btn" data-emoji="&#128293;" title="Fire">&#128293;</button>
                                <button class="emoji-btn" data-emoji="&#128167;" title="Droplet">&#128167;</button>
                                <button class="emoji-btn" data-emoji="&#10052;&#65039;" title="Snowflake">&#10052;&#65039;</button>
                                <button class="emoji-btn" data-emoji="&#127775;" title="Glowing Star">&#127775;</button>
                                <button class="emoji-btn" data-emoji="&#128150;" title="Sparkling Heart">&#128150;</button>
                                <button class="emoji-btn" data-emoji="&#128156;" title="Purple Heart">&#128156;</button>
                                <button class="emoji-btn" data-emoji="&#128153;" title="Blue Heart">&#128153;</button>
                                <button class="emoji-btn" data-emoji="&#128154;" title="Green Heart">&#128154;</button>
                                <button class="emoji-btn" data-emoji="&#128155;" title="Yellow Heart">&#128155;</button>
                                <button class="emoji-btn" data-emoji="&#129505;" title="Orange Heart">&#129505;</button>
                                <button class="emoji-btn" data-emoji="&#127800;" title="Cherry Blossom">&#127800;</button>
                                <button class="emoji-btn" data-emoji="&#127802;" title="Hibiscus">&#127802;</button>
                                <button class="emoji-btn" data-emoji="&#127808;" title="Four Leaf Clover">&#127808;</button>
                                <button class="emoji-btn" data-emoji="&#127810;" title="Fallen Leaf">&#127810;</button>
                                <button class="emoji-btn" data-emoji="&#127809;" title="Maple Leaf">&#127809;</button>
                                <button class="emoji-btn" data-emoji="&#127752;" title="Rainbow">&#127752;</button>
                                <button class="emoji-btn" data-emoji="&#9728;&#65039;" title="Sun">&#9728;&#65039;</button>
                                <button class="emoji-btn" data-emoji="&#127769;" title="Crescent Moon">&#127769;</button>
                                <button class="emoji-btn" data-emoji="&#9889;" title="Lightning">&#9889;</button>
                                <button class="emoji-btn" data-emoji="&#128165;" title="Explosion">&#128165;</button>
                                <button class="emoji-btn" data-emoji="&#128166;" title="Sweat Droplets">&#128166;</button>
                                <button class="emoji-btn" data-emoji="&#129767;" title="Bubbles">&#129767;</button>
                                <button class="emoji-btn" data-emoji="&#127925;" title="Musical Note">&#127925;</button>
                                <button class="emoji-btn" data-emoji="&#127926;" title="Musical Notes">&#127926;</button>
                                <button class="emoji-btn" data-emoji="&#128142;" title="Gem Stone">&#128142;</button>
                                <button class="emoji-btn" data-emoji="&#129689;" title="Coin">&#129689;</button>
                                <button class="emoji-btn" data-emoji="&#127880;" title="Balloon">&#127880;</button>
                                <button class="emoji-btn" data-emoji="&#127881;" title="Party Popper">&#127881;</button>
                                <button class="emoji-btn" data-emoji="&#127882;" title="Confetti Ball">&#127882;</button>
                                <button class="emoji-btn" data-emoji="&#129419;" title="Butterfly">&#129419;</button>
                                <button class="emoji-btn" data-emoji="&#128038;" title="Bird">&#128038;</button>
                                <button class="emoji-btn" data-emoji="&#128031;" title="Fish">&#128031;</button>
                                <button class="emoji-btn" data-emoji="&#127744;" title="Cyclone">&#127744;</button>
                                <button class="emoji-btn" data-emoji="&#128128;" title="Skull">&#128128;</button>
                                <button class="emoji-btn" data-emoji="&#128123;" title="Ghost">&#128123;</button>
                                <button class="emoji-btn" data-emoji="&#127875;" title="Jack-O-Lantern">&#127875;</button>
                            </div>
                            <div class="current-emoji">
                                <span>Current: </span>
                                <span id="current-emoji-display">&#10084;&#65039;</span>
                            </div>
                        </div>
                    </div>

                    <div class="control-row">
                        <label>Size Start <button class="help-icon-small" onclick="showHelp('size')" title="Learn about size">?</button></label>
                        <input type="range" id="sizeStart" min="1" max="50" value="12">
                        <span class="value-display" id="sizeStart-value">12</span>
                    </div>

                    <div class="control-row">
                        <label>Size End</label>
                        <input type="range" id="sizeEnd" min="0" max="50" value="4">
                        <span class="value-display" id="sizeEnd-value">4</span>
                    </div>

                    <div class="control-row color-row">
                        <label>Start Color <button class="help-icon-small" onclick="showHelp('color')" title="Learn about colors">?</button></label>
                        <input type="color" id="colorStart" value="#ff6600">
                    </div>

                    <div class="control-row color-row">
                        <label>End Color</label>
                        <input type="color" id="colorEnd" value="#ff0000">
                    </div>

                    <div class="control-row">
                        <label>Opacity Start <button class="help-icon-small" onclick="showHelp('opacity')" title="Learn about opacity">?</button></label>
                        <input type="range" id="opacityStart" min="0" max="1" step="0.05" value="1">
                        <span class="value-display" id="opacityStart-value">1.0</span>
                    </div>

                    <div class="control-row">
                        <label>Opacity End</label>
                        <input type="range" id="opacityEnd" min="0" max="1" step="0.05" value="0">
                        <span class="value-display" id="opacityEnd-value">0.0</span>
                    </div>

                    <div class="control-row blend-row">
                        <label>Additive Blend <button class="help-icon-small" onclick="showHelp('blending')" title="Learn about blending">?</button></label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="blend-mode">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="blend-hint">Makes overlapping particles glow</span>
                    </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="js/help.js"></script>
    <script src="js/presets.js"></script>
    <script src="js/particle.js"></script>
    <script src="js/emitter.js"></script>
    <script src="js/layers.js"></script>
    <script src="js/history.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/saveload.js"></script>
    <script>
        // ============================================
        // EMBEDDED MODE (GameMaker integration)
        // ============================================
        (function() {
            var params = new URLSearchParams(window.location.search);
            var isEmbedded = params.get('embedded') === '1';
            var embeddedProjectId = params.get('id') || null;
            var presetParam = params.get('preset') || null;

            if (!isEmbedded) return;

            document.body.classList.add('embedded-mode');

            // Listen for messages from parent (GameMaker)
            window.addEventListener('message', function(event) {
                var msg = event.data;
                if (!msg || !msg.action) return;

                if (msg.action === 'loadData') {
                    // Parent is sending project data to load
                    loadProjectData(msg.data);
                }

                if (msg.action === 'save') {
                    // Parent wants us to serialize and send back data
                    var data = getProjectData();
                    event.source.postMessage({
                        action: 'saveComplete',
                        projectId: embeddedProjectId,
                        data: data
                    }, event.origin);
                }
            });

            // Send ready message once engine is available
            function waitForReady() {
                if (typeof getProjectData === 'function' && typeof loadProjectData === 'function') {
                    // Apply preset if specified (for new effects)
                    if (presetParam && typeof loadPreset === 'function') {
                        loadPreset(presetParam);
                    }
                    window.parent.postMessage({
                        action: 'ready',
                        projectId: embeddedProjectId
                    }, '*');
                } else {
                    setTimeout(waitForReady, 100);
                }
            }
            waitForReady();
        })();
    </script>
</body>
</html>
